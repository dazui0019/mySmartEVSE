# 充电桩功能实现

## 延时上(断)电功能

使用一个结构体来保存

```c
struct DelayedTimeStruct {
    uint32_t epoch2;    // 表示延时上电(断)开启的时间,
                        // 如果该变量为0则表示不在延时上电模式
    int32_t diff;       // 开始时间减去当前时间(单位s)
                        // 当diff <= 0时表示延时结束, 开始上电 
};
#define EPOCH2_OFFSET 1672531200    // 2023/1/1的时间戳
// epoch2 使用的时间戳是从2023/1/1开始的

// 计算延时上电的剩余时间
DelayedStartTime.diff = DelayedStartTime.epoch2 - (mktime(localtime(&now)) - EPOCH2_OFFSET);

// 这个用来标记本地时间是否完成同步(同步完成后才能开启延时上电模式)
bool LocalTimeSet = false;
```
### 固件自动更新功能

1. 随机生成一个时间(>10h)
2. 将这个时间倒计时到只剩1h后, 检查是否有固件升级。
3. 如果需要升级, 则继续倒计时, 直到剩余时间为0执行实际的更新操作。
4. 如果不需要更新, 则重新生成一个>10h的时间, 进入下一个固件更新检测循环。

这个随机时可能的作用：
- 设备不会同时检查更新，避免服务器负载峰值
- 确认更新后有延迟（1小时）再执行，避免立即更新可能带来的问题
- 更新检查间隔至少为10小时，避免频繁检查

## Timer10ms_loop()

### 背光控制逻辑

这里有两个变量, 用来控制背光状态:
- `BacklightTimer`: 用来控制背光开启的时间(单位: 秒)
  - 这个变量一秒钟递减一次
- `BacklightSet`: 背光状态
   - `BacklightSet == 1`表示背光全开
   - `BacklightSet == 2`表示背光进入渐灭状态
   - `BacklightSet == 0`表示背光关闭
